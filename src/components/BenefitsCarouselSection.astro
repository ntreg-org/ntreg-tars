---
import { storyblokEditable } from '@storyblok/astro';
import { renderRichText } from '@storyblok/js';
import BenefitCard from './BenefitCard.astro';

const { blok } = Astro.props;

const headline = blok?.headline ?? '';
const cards = Array.isArray(blok?.benefit_cards) ? blok.benefit_cards : [];
const headingId = `benefits-carousel-heading-${blok._uid}`;
const carouselId = `benefits-carousel-${blok._uid}`;
---

<section id="benefits" data-anchor
  class="benefits-carousel-section bg-brand-primary py-section"
  aria-labelledby={headline ? headingId : undefined}
  {...storyblokEditable(blok)}
>
  <div class="page-grid">
    {/* Header row: headline + body */}
    <header class="col-span-12 benefits-carousel__header">
      <div class="benefits-carousel__header-grid">
        {headline && (
          <h2
            id={headingId}
            class="benefits-carousel__headline text-brand-highlight"
          >
            {headline}
          </h2>
        )}

        {blok.body && (
          <div
            class="benefits-carousel__body text-brand-on-dark"
            set:html={renderRichText(blok.body)}
          />
        )}
      </div>

      {/* Carousel nav buttons (hidden on mobile via CSS) */}
      <div class="benefits-carousel__nav-group">
        <button
          type="button"
          class="benefits-carousel__nav benefits-carousel__nav--prev"
          aria-label="Scroll benefits to the left"
        >
          ←
        </button>
        <button
          type="button"
          class="benefits-carousel__nav benefits-carousel__nav--next"
          aria-label="Scroll benefits to the right"
        >
          →
        </button>
      </div>
    </header>

    {/* Spacer between header and cards */}
    <div class="col-span-12 space-block-md" aria-hidden="true"></div>

    {/* Carousel */}
    {cards.length > 0 && (
      <div
        class="col-span-12 benefits-carousel benefits-carousel--bleed"
        id={carouselId}
        data-carousel-id={blok._uid}
      >
        <div class="benefits-carousel__viewport" tabindex="0">
          <ul
            class="benefits-carousel__track"
            aria-label="Benefits of rooftop solar"
          >
            {cards.map((card: any) => (
              <BenefitCard blok={card} />
            ))}
          </ul>
        </div>
      </div>
    )}

    {/* Source text */}
    {blok.source && (
      <div class="col-span-12 space-block-md" aria-hidden="true"></div>
    )}

    {blok.source && (
      <footer class="col-span-12 benefits-carousel__source">
        <div
          class="benefits-carousel__source-text text-fine"
          set:html={renderRichText(blok.source)}
        ></div>
      </footer>
    )}
  </div>
</section>

<!-- Carousel behaviour -->
<script is:inline>
  (function () {
    const bindSection = (section) => {
      if (!section || !(section instanceof HTMLElement)) return;
      if (section.dataset.carouselBound === 'true') return;

      const viewport = section.querySelector('.benefits-carousel__viewport');
      const track = section.querySelector('.benefits-carousel__track');
      const prevBtn = section.querySelector('.benefits-carousel__nav--prev');
      const nextBtn = section.querySelector('.benefits-carousel__nav--next');

      if (!viewport || !track || !prevBtn || !nextBtn) return;

      section.dataset.carouselBound = 'true';

      const getGap = () => {
        const s = window.getComputedStyle(track);
        const gapValue = s.columnGap || s.gap || '0px';
        const gap = parseFloat(String(gapValue).split(' ')[0]);
        return Number.isFinite(gap) ? gap : 0;
      };

      const getCardWidth = () => {
        const card = track.querySelector('.benefits-card');
        if (!card) return viewport.clientWidth;
        return card.getBoundingClientRect().width;
      };

      const getStep = () => Math.round(getCardWidth() + getGap());

      const scrollByStep = (dir) => {
        // Use a numeric fallback in case smooth scrolling is disabled
        const step = getStep();
        viewport.scrollBy({ left: dir * step, behavior: 'smooth' });
      };

      prevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        scrollByStep(-1);
      });

      nextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        scrollByStep(1);
      });

      // Keyboard support when the viewport is focused
      viewport.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          scrollByStep(-1);
        }
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          scrollByStep(1);
        }
      });
    };

    const init = () => {
      document.querySelectorAll('.benefits-carousel-section').forEach(bindSection);
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // If Astro client-side navigation is enabled
    document.addEventListener('astro:page-load', init);
  })();
</script>