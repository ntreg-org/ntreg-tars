---
import { storyblokEditable } from '@storyblok/astro';

type StoryblokLinkField = {
  url?: string;
  cached_url?: string;
};

type NavLinkBlok = {
  _uid: string;
  text?: string;
  link?: StoryblokLinkField;
};

const { blok } = Astro.props;

// Logo
const logoUrl = blok?.logo?.filename ?? '';
const logoAlt = blok?.logo?.alt ?? 'NTREG';

// Nav links from nested blocks
const links: NavLinkBlok[] = Array.isArray(blok?.nav_links)
  ? blok.nav_links
  : [];

// PDF link (from asset)
const pdfLabel = blok?.pdf_text ?? 'PDF';
const pdfHref = blok?.pdf_file?.filename ?? '#';

// Donate button
const donateLabel = blok?.button_text ?? 'Donate';
const donateHref =
  blok?.button_link?.url ??
  blok?.button_link?.cached_url ??
  '#';
---

<header
  class="fixed inset-x-0 top-0 z-20"
  {...storyblokEditable(blok)}
>
  <div class="nav-shell" data-nav-shell>
    <div class="page-grid">
      <div class="nav-bar">
        <!-- Left: Logo -->
        <a
          href="/"
          class="nav-logo-wrapper flex items-center shrink-0"
          aria-label="NTREG home"
        >
          {logoUrl && (
            <img
              src={logoUrl}
              alt={logoAlt}
              class="nav-logo-img"
              loading="lazy"
            />
          )}
        </a>

        <!-- Center: Navigation Links -->
        <nav class="nav-center">
          {links.map((item, index) => {
            const label = item?.text ?? '';
            const href =
              item?.link?.url ??
              item?.link?.cached_url ??
              '#';

            if (!label) return null;

            const classes = [
              'nav-link',
              index === 0 ? 'nav-link--topic' : '',
              index === 1 ? 'nav-link--page-title' : ''
            ]
              .filter(Boolean)
              .join(' ');

            return (
              <a
                href={href}
                class={classes}
                data-blok-uid={item._uid}
              >
                {label}
              </a>
            );
          })}
        </nav>

        <!-- Right: PDF + Donate -->
        <div class="nav-right">
          <a href={pdfHref} class="nav-link inline-flex items-center gap-1">
            <span>{pdfLabel}</span>
            <span aria-hidden="true">⬇︎</span>
          </a>

          <a href={donateHref} class="nav-cta">
            {donateLabel}
          </a>
        </div>
      </div>
    </div>
  </div>
</header>
</header>
<script is:inline>
  if (typeof window !== 'undefined') {
    const shell = document.querySelector('[data-nav-shell]');

    const computeThreshold = () => {
      const hero = document.querySelector('.hero-section');
      if (!hero || !shell) {
        return 80; // fallback: switch after a small scroll
      }
      const rect = hero.getBoundingClientRect();
      const scrollTop = window.scrollY || window.pageYOffset;
      const heroBottom = rect.top + scrollTop + rect.height;
      const navHeight = shell.offsetHeight || 0;
      return heroBottom - navHeight;
    };

    let threshold = computeThreshold();

    const onScroll = () => {
      if (!shell) return;
      if (window.scrollY > threshold) {
        shell.classList.add('nav-shell--solid');
      } else {
        shell.classList.remove('nav-shell--solid');
      }
    };

    const onResize = () => {
      threshold = computeThreshold();
      onScroll();
    };

    window.addEventListener('scroll', onScroll);
    window.addEventListener('resize', onResize);

    onScroll();
  }
</script>